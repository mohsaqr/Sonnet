---
title: "mcml() Refactoring Test"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 8, fig.height = 8)
devtools::load_all(".")
```

## Test 1: mcml() Data Extraction

```{r mcml-extract}
set.seed(42)
weights <- matrix(runif(36), 6, 6)
diag(weights) <- 0
colnames(weights) <- rownames(weights) <- LETTERS[1:6]

cluster_list <- list(
  Cluster1 = c("A", "B"),
  Cluster2 = c("C", "D"),
  Cluster3 = c("E", "F")
)

# Extract data using mcml()
data <- mcml(weights, cluster_list)
print(data)
```

## Transition Matrix

The transition matrix shows the probability of transitioning from one cluster to another. Each row sums to 1.

```{r transition}
round(data$transition_matrix, 3)
```

Row sums (should all be 1):
```{r row-sums}
rowSums(data$transition_matrix)
```

## Aggregated Matrix

Full aggregated weight matrix with within-cluster weights on diagonal:

```{r aggregated}
round(data$aggregated_matrix, 3)
```

## Between-Cluster Weights

Only between-cluster weights (diagonal = 0):

```{r between}
round(data$between_weights, 3)
```

## Within-Cluster Weights

Aggregated internal connectivity of each cluster:

```{r within}
round(data$within_weights, 3)
```

## Test 2: plot_mcml() from Matrix

```{r plot-from-matrix}
plot_mcml(weights, cluster_list, title = "From Matrix")
```

## Test 3: plot_mcml() from cograph_mcml

```{r plot-from-mcml}
# Pre-extract data
data <- mcml(weights, cluster_list, aggregation = "mean")

# Plot from pre-extracted data
plot_mcml(data, title = "From Pre-extracted Data (mean aggregation)")
```

## Test 4: Different Aggregation Methods

```{r aggregation-methods, fig.width=12, fig.height=4}
par(mfrow = c(1, 3))
plot_mcml(weights, cluster_list, aggregation = "sum", title = "Sum")
plot_mcml(weights, cluster_list, aggregation = "mean", title = "Mean")
plot_mcml(weights, cluster_list, aggregation = "max", title = "Max")
par(mfrow = c(1, 1))
```

## Transition Matrices by Aggregation Method

```{r transition-by-agg}
cat("=== Sum Aggregation ===\n")
round(mcml(weights, cluster_list, aggregation = "sum")$transition_matrix, 3)

cat("\n=== Mean Aggregation ===\n")
round(mcml(weights, cluster_list, aggregation = "mean")$transition_matrix, 3)

cat("\n=== Max Aggregation ===\n")
round(mcml(weights, cluster_list, aggregation = "max")$transition_matrix, 3)
```
