---
title: "Motif Analysis Demo"
subtitle: "cograph package - Refactored motif functions"
output:
  html_document:
    theme: flatly
    toc: true
    toc_float: true
    code_folding: show
    fig_width: 10
    fig_height: 7
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, message = FALSE, warning = FALSE,
  fig.align = "center", dpi = 120
)
devtools::load_all(".")
library(igraph)
```

## Overview

The motif analysis functions are now split across 5 focused files:

| File | Contents |
|------|----------|
| `R/motifs-data.R` | Shared constants: triad patterns (2 versions), MAN descriptions, theme |
| `R/motifs.R` | Core: `motif_census()`, `triad_census()`, `extract_triads()`, `get_edge_list()` |
| `R/motifs-extract.R` | `extract_motifs()` pipeline with print/plot methods |
| `R/motifs-plot.R` | Visualization helpers (bar, heatmap, network, triad diagrams) |
| `R/motifs-temporal.R` | `extract_motifs_temporal()`, `triad_persistence()` + methods |

---

## 1. motif_census()

Statistical analysis of network motifs against a null model.

```{r motif-census-data}
# Create a directed network with clear structure
set.seed(42)
mat <- matrix(0, 8, 8)
rownames(mat) <- colnames(mat) <- paste0("N", 1:8)

# Add structured edges (feed-forward loops, cycles, stars)
mat[1, 2] <- 1; mat[2, 3] <- 1; mat[1, 3] <- 1  # 030T: feed-forward
mat[4, 5] <- 1; mat[5, 6] <- 1; mat[6, 4] <- 1  # 030C: cycle
mat[7, 1] <- 1; mat[7, 2] <- 1; mat[7, 3] <- 1  # out-star from N7
mat[1, 8] <- 1; mat[2, 8] <- 1; mat[3, 8] <- 1  # in-star to N8
mat[4, 7] <- 1; mat[5, 8] <- 1; mat[6, 7] <- 1  # cross-connections

m <- motif_census(mat, directed = TRUE, n_random = 200, seed = 123)
print(m)
```

### Bar plot (default)

```{r motif-census-bar, fig.height=5}
plot(m, show_nonsig = TRUE)
```

### Heatmap

```{r motif-census-heatmap, fig.height=5}
plot(m, type = "heatmap", show_nonsig = TRUE)
```

### Network visualization

```{r motif-census-network, fig.height=8}
plot(m, type = "network", show_nonsig = TRUE)
```

---

## 2. triad_census()

Simple count of the 16 MAN triad types.

```{r triad-census}
tc <- cograph::triad_census(mat)
tc_df <- data.frame(
  Type = names(tc),
  Count = as.integer(tc),
  Description = .get_man_descriptions()[names(tc)]
)
tc_df <- tc_df[tc_df$Count > 0, ]
knitr::kable(tc_df, row.names = FALSE, caption = "Non-zero triad types")
```

---

## 3. extract_triads()

Extract specific triads with node labels and edge weights.

```{r extract-triads}
# Use a weighted matrix
wmat <- matrix(0, 6, 6)
rownames(wmat) <- colnames(wmat) <- c("Plan", "Execute", "Monitor", "Adapt", "Review", "Reflect")
wmat["Plan", "Execute"] <- 15; wmat["Execute", "Monitor"] <- 12
wmat["Monitor", "Adapt"] <- 8;  wmat["Adapt", "Plan"] <- 10
wmat["Plan", "Monitor"] <- 6;   wmat["Execute", "Adapt"] <- 4
wmat["Review", "Reflect"] <- 9; wmat["Reflect", "Review"] <- 7
wmat["Monitor", "Review"] <- 5; wmat["Review", "Plan"] <- 3
wmat["Adapt", "Review"] <- 6;   wmat["Execute", "Review"] <- 2

triads <- extract_triads(wmat, min_total = 0)
knitr::kable(head(triads[order(-triads$total_weight), ], 10),
             row.names = FALSE,
             caption = "Top 10 triads by total weight")
```

### Filter by motif type

```{r extract-triads-filter}
# Only feed-forward loops
ff <- extract_triads(wmat, type = "030T", min_total = 0)
if (nrow(ff) > 0) {
  knitr::kable(ff, row.names = FALSE, caption = "Feed-forward loops (030T)")
} else {
  cat("No feed-forward loops found\n")
}

# Triads involving "Plan"
plan_triads <- extract_triads(wmat, involving = "Plan", min_total = 0)
knitr::kable(head(plan_triads, 10), row.names = FALSE,
             caption = "Triads involving 'Plan'")
```

---

## 4. extract_motifs()

Detailed motif extraction with flexible filtering and optional significance testing.

### From a matrix (aggregate level)

```{r extract-motifs-matrix}
em <- extract_motifs(wmat, pattern = "all", min_transitions = 0)
print(em)
```

### Triad network diagrams (default plot)

```{r extract-motifs-triads, fig.height=8}
plot(em, n = 15, ncol = 5, node_size = 5, label_size = 6, title_size = 8)
```

### Type distribution bar plot

```{r extract-motifs-types, fig.height=5}
plot(em, type = "types")
```

### Abstract MAN patterns

```{r extract-motifs-patterns, fig.height=8}
plot(em, type = "patterns")
```

### With significance testing

```{r extract-motifs-sig}
if (requireNamespace("tna", quietly = TRUE)) {
  library(tna)
  Mod <- tna(group_regulation)

  em_sig <- extract_motifs(Mod, pattern = "triangle",
                           significance = TRUE, n_perm = 50,
                           top = 20, seed = 42)
  print(em_sig)
} else {
  cat("tna package not available - skipping significance test demo\n")
}
```

```{r extract-motifs-sig-plot, fig.height=8, eval=requireNamespace("tna", quietly=TRUE)}
plot(em_sig, n = 20, ncol = 5, node_size = 5, label_size = 6)
```

```{r extract-motifs-sig-zscore, fig.height=6, eval=requireNamespace("tna", quietly=TRUE)}
plot(em_sig, type = "significance")
```

---

## 5. extract_motifs_temporal()

Track motif evolution across time windows.

```{r temporal-data}
if (requireNamespace("tna", quietly = TRUE)) {
  data <- group_regulation

  tm <- extract_motifs_temporal(
    data,
    window_size = 5,
    step = 2,
    pattern = "all",
    min_transitions = 5
  )
  print(tm)
} else {
  cat("tna package not available - skipping temporal demo\n")
}
```

### Trends plot

```{r temporal-trends, fig.height=5, eval=requireNamespace("tna", quietly=TRUE)}
plot(tm, type = "trends", top_n = 8)
```

### Heatmap

```{r temporal-heatmap, fig.height=5, eval=requireNamespace("tna", quietly=TRUE)}
plot(tm, type = "heatmap")
```

---

## 6. triad_persistence()

Analyze which triads persist, emerge, or fade across time.

### By specific triads

```{r persistence-triad, eval=requireNamespace("tna", quietly=TRUE)}
pers <- triad_persistence(tm, by = "triad", min_windows = 1)
print(pers)
```

```{r persistence-triad-heatmap, fig.height=8, eval=requireNamespace("tna", quietly=TRUE)}
plot(pers, type = "heatmap", top_n = 25)
```

```{r persistence-triad-timeline, fig.height=6, eval=requireNamespace("tna", quietly=TRUE)}
plot(pers, type = "timeline", top_n = 20)
```

```{r persistence-triad-status, fig.height=4, eval=requireNamespace("tna", quietly=TRUE)}
plot(pers, type = "status")
```

### By MAN type

```{r persistence-type, eval=requireNamespace("tna", quietly=TRUE)}
pers_type <- triad_persistence(tm, by = "type")
print(pers_type)
```

```{r persistence-type-heatmap, fig.height=5, eval=requireNamespace("tna", quietly=TRUE)}
plot(pers_type, type = "heatmap")
```

```{r persistence-type-norm, fig.height=5, eval=requireNamespace("tna", quietly=TRUE)}
plot(pers_type, type = "heatmap", normalize = TRUE)
```

---

## File Structure Summary

After refactoring, here are the line counts:

```{r file-lines, echo=FALSE}
files <- c("R/motifs-data.R", "R/motifs.R", "R/motifs-extract.R",
           "R/motifs-plot.R", "R/motifs-temporal.R")
lines <- vapply(files, function(f) length(readLines(file.path("..", f))), integer(1))
df <- data.frame(File = files, Lines = lines)
df <- rbind(df, data.frame(File = "**Total**", Lines = sum(lines)))
knitr::kable(df, row.names = FALSE)
```

**Original:** 3,220 lines in a single file
**After refactoring:** `r sum(lines[1:5])` lines across 5 files (`r round((1 - sum(lines[1:5])/3220) * 100, 0)`% reduction)
